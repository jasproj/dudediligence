<!-- EDITABLE REVIEW FORM - INSERT AFTER RISK ASSESSMENT SECTION -->
<!-- This appears AFTER AI extraction but BEFORE final scoring -->

<div id="reviewFormSection" class="hidden rounded-2xl border border-cyan-500/60 bg-slate-950/80 backdrop-blur shadow-lg shadow-cyan-500/10 mt-6">
<div class="px-5 py-4 border-b border-slate-800">
<h2 class="text-sm font-semibold text-cyan-400">âœï¸ Review & Edit Extracted Data</h2>
<p class="text-xs text-slate-400 mt-1">AI extracted the data below. Please review and add any missing information before finalizing.</p>
</div>

<div class="px-5 py-4 space-y-4">
<!-- Company Information -->
<div class="bg-slate-900/60 p-4 rounded-lg border border-slate-800">
<h3 class="text-xs font-semibold text-slate-300 mb-3">ğŸ¢ Company Information</h3>
<div class="grid gap-3">
<div>
<label class="block text-[11px] text-slate-500 mb-1">Company Name</label>
<input type="text" id="edit_company_name" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_company_name"></p>
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Country</label>
<input type="text" id="edit_country" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_country"></p>
</div>
</div>
</div>

<!-- Representative Information -->
<div class="bg-slate-900/60 p-4 rounded-lg border border-slate-800">
<h3 class="text-xs font-semibold text-slate-300 mb-3">ğŸ‘¤ Representative Information</h3>
<div class="grid gap-3">
<div>
<label class="block text-[11px] text-slate-500 mb-1">Representative Name</label>
<input type="text" id="edit_representative" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_representative"></p>
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Email Address</label>
<input type="email" id="edit_email" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_email"></p>
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Passport Number (if KYC)</label>
<input type="text" id="edit_passport" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_passport"></p>
</div>
</div>
</div>

<!-- Banking Information (KYC) -->
<div class="bg-slate-900/60 p-4 rounded-lg border border-slate-800">
<h3 class="text-xs font-semibold text-slate-300 mb-3">ğŸ¦ Banking Information</h3>
<div class="grid gap-3">
<div>
<label class="block text-[11px] text-slate-500 mb-1">Bank Name</label>
<input type="text" id="edit_bank_name" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_bank_name"></p>
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Account Number</label>
<input type="text" id="edit_account_number" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_account_number"></p>
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Source of Funds</label>
<input type="text" id="edit_source_funds" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
<p class="text-[10px] text-slate-500 mt-1" id="status_source_funds"></p>
</div>
</div>
</div>

<!-- Trading Information (LOI/ICPO) -->
<div class="bg-slate-900/60 p-4 rounded-lg border border-slate-800">
<h3 class="text-xs font-semibold text-slate-300 mb-3">ğŸ“¦ Trading Information</h3>
<div class="grid gap-3">
<div>
<label class="block text-[11px] text-slate-500 mb-1">Commodity</label>
<input type="text" id="edit_commodity" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Quantity</label>
<input type="text" id="edit_quantity" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
</div>
<div>
<label class="block text-[11px] text-slate-500 mb-1">Price</label>
<input type="text" id="edit_price" 
class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 focus:outline-none focus:border-cyan-500 transition"
placeholder="Not specified">
</div>
</div>
</div>

<!-- Finalize Button -->
<div class="flex items-center gap-3 pt-4 border-t border-slate-800">
<button onclick="finalizeReport()" 
class="flex-1 inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 px-4 py-3 text-sm font-semibold text-white hover:from-cyan-600 hover:to-blue-600 transition shadow-lg">
âœ“ Finalize & Calculate Risk Score
</button>
<button onclick="cancelReview()" 
class="px-4 py-3 rounded-lg bg-slate-800 text-sm text-slate-300 hover:bg-slate-700 transition border border-slate-700">
Cancel
</button>
</div>

<p class="text-[10px] text-slate-500 text-center mt-2">
ğŸ’¡ Tip: The more complete the data, the more accurate the risk assessment
</p>
</div>
</div>

<script>
// Global variable to store AI extracted data
let aiExtractedData = null;

// Function to show review form with AI-extracted data
function showReviewForm(extractedData) {
    aiExtractedData = extractedData;
    
    // Populate form fields with AI data
    document.getElementById('edit_company_name').value = extractedData.buyer?.name || '';
    document.getElementById('edit_country').value = extractedData.buyer?.country || '';
    document.getElementById('edit_representative').value = extractedData.buyer?.representative || '';
    document.getElementById('edit_email').value = extractedData.buyer?.email || '';
    document.getElementById('edit_commodity').value = extractedData.commodity || '';
    document.getElementById('edit_quantity').value = extractedData.quantity || '';
    document.getElementById('edit_price').value = extractedData.price || '';
    
    // Parse banking info from paymentTerms if it exists
    if (extractedData.paymentTerms && extractedData.paymentTerms !== 'Not specified') {
        const bankMatch = extractedData.paymentTerms.match(/Bank:\s*([^|]+)/);
        const accountMatch = extractedData.paymentTerms.match(/Account:\s*([^|]+)/);
        if (bankMatch) document.getElementById('edit_bank_name').value = bankMatch[1].trim();
        if (accountMatch) document.getElementById('edit_account_number').value = accountMatch[1].trim();
    }
    
    // Parse source of funds from deliveryTerms if it exists
    if (extractedData.deliveryTerms && extractedData.deliveryTerms.includes('Source of Funds')) {
        const fundsMatch = extractedData.deliveryTerms.match(/Source of Funds:\s*(.+)/);
        if (fundsMatch) document.getElementById('edit_source_funds').value = fundsMatch[1].trim();
    }
    
    // Parse passport from representative name if it exists
    if (extractedData.buyer?.representative && extractedData.buyer.representative.includes('Passport:')) {
        const passportMatch = extractedData.buyer.representative.match(/Passport:\s*([A-Z0-9]+)/);
        if (passportMatch) document.getElementById('edit_passport').value = passportMatch[1];
    }
    
    // Show status indicators
    updateFieldStatuses(extractedData);
    
    // Show the review form
    document.getElementById('reviewFormSection').classList.remove('hidden');
    
    // Scroll to review form
    document.getElementById('reviewFormSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Update field status indicators
function updateFieldStatuses(data) {
    const setStatus = (fieldId, value) => {
        const statusEl = document.getElementById(`status_${fieldId}`);
        if (!statusEl) return;
        
        if (!value || value === 'Not specified') {
            statusEl.textContent = 'âš ï¸ Missing - please add';
            statusEl.className = 'text-[10px] text-yellow-400 mt-1';
        } else {
            statusEl.textContent = 'âœ“ AI extracted';
            statusEl.className = 'text-[10px] text-emerald-400 mt-1';
        }
    };
    
    setStatus('company_name', data.buyer?.name);
    setStatus('country', data.buyer?.country);
    setStatus('representative', data.buyer?.representative);
    setStatus('email', data.buyer?.email);
}

// Finalize report with user-verified data
async function finalizeReport() {
    // Collect all form data
    const verifiedData = {
        documentType: aiExtractedData.documentType,
        buyer: {
            name: document.getElementById('edit_company_name').value || 'Not specified',
            country: document.getElementById('edit_country').value || 'Not specified',
            representative: document.getElementById('edit_representative').value || 'Not specified',
            email: document.getElementById('edit_email').value || 'Not specified'
        },
        seller: aiExtractedData.seller || { name: 'Not specified', country: 'Not specified', email: 'Not specified' },
        commodity: document.getElementById('edit_commodity').value || 'Not specified',
        quantity: document.getElementById('edit_quantity').value || 'Not specified',
        price: document.getElementById('edit_price').value || 'Not specified',
        paymentTerms: 'Not specified',
        deliveryTerms: 'Not specified',
        port: aiExtractedData.port || 'Not specified'
    };
    
    // Build banking info
    const bankName = document.getElementById('edit_bank_name').value;
    const accountNumber = document.getElementById('edit_account_number').value;
    if (bankName || accountNumber) {
        verifiedData.paymentTerms = `Bank: ${bankName || 'Not specified'} | Account: ${accountNumber || 'Not specified'}`;
    }
    
    // Add source of funds
    const sourceFunds = document.getElementById('edit_source_funds').value;
    if (sourceFunds) {
        verifiedData.deliveryTerms = `Source of Funds: ${sourceFunds}`;
    }
    
    // Add passport to representative if provided
    const passport = document.getElementById('edit_passport').value;
    if (passport) {
        verifiedData.buyer.representative += ` (Passport: ${passport})`;
    }
    
    // Hide review form
    document.getElementById('reviewFormSection').classList.add('hidden');
    
    // Update status
    document.getElementById('statusMessage').textContent = 'ğŸ¯ Calculating risk score with verified data...';
    
    // Run scoring with verified data
    const scoring = calculateRuleBasedScore(verifiedData);
    const blacklistHits = checkBlacklist(verifiedData);
    const sanctionsHits = checkSanctions(verifiedData);
    
    // Get document reuse check from original analysis
    const reuseCheck = {
        isReused: false,
        timesUsed: 1
    };
    
    const riskLevel = determineRiskLevel(scoring.score, blacklistHits, sanctionsHits, reuseCheck);
    
    // Generate next steps
    const nextSteps = [];
    if (riskLevel === 'BLACK') {
        nextSteps.push("â›” DO NOT PROCEED");
        nextSteps.push("Report to compliance");
    } else if (riskLevel === 'RED') {
        nextSteps.push("Require full KYC pack");
        nextSteps.push("Verify company registration");
        nextSteps.push("Request bank reference");
    } else if (riskLevel === 'YELLOW') {
        nextSteps.push("Request business license");
        nextSteps.push("Verify contact info");
        nextSteps.push("Proceed with caution");
    } else {
        nextSteps.push("Standard due diligence");
        nextSteps.push("Verify final docs");
    }
    
    // Store result
    currentResult = {
        score: scoring.score,
        riskLevel,
        summary: `${riskLevel} risk with ${scoring.score}/100 score. ${blacklistHits.length > 0 ? 'BLACKLIST HITS. ' : ''}${sanctionsHits.length > 0 ? 'SANCTIONS HITS. ' : ''}${scoring.redFlags.length} red flags detected. USER-VERIFIED DATA.`,
        redFlags: scoring.redFlags,
        positiveSignals: scoring.positiveSignals,
        nextSteps,
        documentFingerprint: {
            hash: currentHash,
            isReused: false,
            timesUsed: 1
        },
        blacklistHits,
        sanctionsHits,
        extractedData: verifiedData,
        userVerified: true,
        timestamp: new Date().toISOString()
    };
    
    // Update UI
    updateResultsUI(currentResult);
    document.getElementById('statusMessage').textContent = 'âœ“ Analysis complete with user-verified data!';
    
    // Scroll to results
    document.getElementById('score').scrollIntoView({ behavior: 'smooth' });
}

// Cancel review and use AI data as-is
function cancelReview() {
    document.getElementById('reviewFormSection').classList.add('hidden');
    
    // Continue with AI extracted data
    continueWithAIData();
}

// Continue analysis with original AI data
function continueWithAIData() {
    document.getElementById('statusMessage').textContent = 'ğŸ¯ Calculating risk score...';
    
    const extracted = aiExtractedData;
    const scoring = calculateRuleBasedScore(extracted);
    const blacklistHits = checkBlacklist(extracted);
    const sanctionsHits = checkSanctions(extracted);
    
    const reuseCheck = {
        isReused: false,
        timesUsed: 1
    };
    
    const riskLevel = determineRiskLevel(scoring.score, blacklistHits, sanctionsHits, reuseCheck);
    
    const nextSteps = [];
    if (riskLevel === 'BLACK') {
        nextSteps.push("â›” DO NOT PROCEED");
        nextSteps.push("Report to compliance");
    } else if (riskLevel === 'RED') {
        nextSteps.push("Require full KYC pack");
        nextSteps.push("Verify company registration");
        nextSteps.push("Request bank reference");
    } else if (riskLevel === 'YELLOW') {
        nextSteps.push("Request business license");
        nextSteps.push("Verify contact info");
        nextSteps.push("Proceed with caution");
    } else {
        nextSteps.push("Standard due diligence");
        nextSteps.push("Verify final docs");
    }
    
    currentResult = {
        score: scoring.score,
        riskLevel,
        summary: `${riskLevel} risk with ${scoring.score}/100 score. ${blacklistHits.length > 0 ? 'BLACKLIST HITS. ' : ''}${sanctionsHits.length > 0 ? 'SANCTIONS HITS. ' : ''}${scoring.redFlags.length} red flags detected.`,
        redFlags: scoring.redFlags,
        positiveSignals: scoring.positiveSignals,
        nextSteps,
        documentFingerprint: {
            hash: currentHash,
            isReused: false,
            timesUsed: 1
        },
        blacklistHits,
        sanctionsHits,
        extractedData: extracted,
        timestamp: new Date().toISOString()
    };
    
    updateResultsUI(currentResult);
    document.getElementById('statusMessage').textContent = 'âœ“ Analysis complete.';
}
</script>
